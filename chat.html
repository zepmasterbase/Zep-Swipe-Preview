<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZepChat ‚Äî Supabase Live Chat (Voice / Reactions / E2E)</title>

<!-- supabase-js -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.27.0/dist/umd/supabase.min.js"></script>
<!-- Tailwind optional for quick styling utilities -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --accent-cyan:#00f0ff; --accent-lime:#a6ff00; --muted:#bfefff; --card:rgba(255,255,255,0.035); --glass-border:rgba(255,255,255,0.06); --radius:12px;
}
body{margin:0; font-family:'Poppins',system-ui; background:radial-gradient(circle at 10% 10%, #04000e 0%, #02000a 60%); color:var(--muted); -webkit-font-smoothing:antialiased; padding-bottom:120px;}
.container{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
@media(max-width:1024px){.container{grid-template-columns:1fr}.sidebar-left,.sidebar-right{display:none}.sidebar-left.open,.sidebar-right.open{display:block;position:fixed;inset:80px 12px 120px 12px;z-index:120}}
.glass{background:var(--card);border-radius:var(--radius);border:1px solid var(--glass-border);padding:12px;backdrop-filter:blur(12px) saturate(130%);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.logo{font-family:'Orbitron';font-weight:700;font-size:20px;background:linear-gradient(90deg,var(--accent-cyan),#ff00f0,var(--accent-lime));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-left{height:calc(100vh - 72px);overflow:auto;display:flex;flex-direction:column;gap:10px}
.search{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.search input{background:transparent;border:none;outline:none;color:var(--muted);width:100%}
.contacts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.contact{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;cursor:pointer;border:1px solid transparent;transition:all .16s}
.contact:hover{transform:translateY(-4px);background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.03)}
.avatar{width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.04)}
.dot{width:10px;height:10px;border-radius:999px;background:#3affc1;box-shadow:0 0 8px #3affc1}
.chat-area{display:flex;flex-direction:column;height:calc(100vh - 72px)}
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:8px 6px}
.chat-main{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.messages{display:flex;flex-direction:column;gap:12px;max-width:100%}
.msg-row{display:flex;gap:8px;align-items:flex-end}
.msg{max-width:72%;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.25;position:relative;word-break:break-word}
.msg.me{margin-left:auto;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-lime));color:#061018;border-radius:12px 12px 6px 12px;box-shadow:0 8px 24px rgba(0,240,255,0.06)}
.msg.them{background:rgba(255,255,255,0.02);color:var(--muted);border-radius:12px 12px 12px 6px;border:1px solid rgba(255,255,255,0.02)}
.meta{font-size:11px;color:rgba(190,239,255,0.6);margin-top:6px;display:flex;gap:8px;align-items:center}
.msg img{max-width:220px;border-radius:10px;display:block;margin-top:8px}
.composer{display:flex;gap:8px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.composer textarea{flex:1;resize:none;background:transparent;border:none;outline:none;color:var(--muted);font-size:14px;min-height:44px;max-height:110px;padding:6px}
.icon-btn{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer}
.icon-btn svg{width:20px;height:20px;fill:var(--accent-cyan);filter:drop-shadow(0 0 6px rgba(0,240,255,0.06))}
.quick-chips{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.chip{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;font-weight:600;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
.sidebar-right{height:calc(100vh - 72px);overflow:auto;display:flex;flex-direction:column;gap:12px}
.contact-card{display:flex;flex-direction:column;gap:10px;align-items:center;padding:14px;text-align:center}
.detail-row{width:100%;display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.kv{color:var(--muted);font-size:13px}
.btn-primary{background:linear-gradient(90deg,var(--accent-cyan),var(--accent-lime));color:#051018;padding:10px 12px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}
.page-footer{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);z-index:80;background:rgba(5,7,14,0.7);border-radius:999px;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.page-footer a{display:inline-flex;align-items:center;justify-content:center;width:50px;height:50px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.page-footer svg{width:24px;height:24px;filter:drop-shadow(0 0 10px rgba(0,240,255,0.08));fill:var(--accent-cyan)}
.emoji-panel{position:absolute;bottom:80px;right:20px;width:360px;max-width:calc(100% - 24px);background:var(--card);border:1px solid var(--glass-border);border-radius:12px;padding:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6);z-index:200}
.emoji-tabs{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.emoji-tab{padding:6px 8px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:600;color:var(--muted)}
.emoji-tab.active{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.05)}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:220px;overflow:auto;padding:6px}
.emoji-cell{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;cursor:pointer;font-size:18px}
.image-bubble{position:relative;width:56px;height:56px;border-radius:999px;overflow:hidden;box-shadow:0 8px 22px rgba(0,0,0,0.6);border:2px solid rgba(255,255,255,0.06);margin-right:8px}
.image-bubble img{width:100%;height:100%;object-fit:cover}
.remove-bubble{position:absolute;top:-6px;right:-6px;background:#ff4d84;color:white;width:20px;height:20px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:12px;border:2px solid rgba(255,255,255,0.06);cursor:pointer}
.reaction-popper{position:absolute;background:var(--card);border:1px solid var(--glass-border);padding:6px;border-radius:999px;display:flex;gap:6px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:300}
.reaction-display{display:flex;gap:6px;margin-top:6px}
.reaction-pill{background:rgba(255,255,255,0.02);padding:4px 8px;border-radius:999px;font-weight:700}
.encryption-badge{font-size:12px;color:var(--accent-lime);padding:6px;border-radius:8px;border:1px solid rgba(0,255,0,0.06);background:rgba(166,255,0,0.03)}
.hidden{display:none}
</style>
</head>
<body>

<!-- MAIN LAYOUT -->
<div class="container">

  <!-- LEFT: CONTACTS -->
  <aside class="sidebar-left glass" id="sidebarLeft">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">ZEP CHAT</div>
      <div style="margin-left:auto">
        <button id="openAddContact" class="icon-btn" title="Add contact">
          <svg viewBox="0 0 24 24"><path d="M15 12c2.8 0 8 1.4 8 4v3H2v-3c0-2.6 5.1-4 8-4h5zm-3-7a3 3 0 110 6 3 3 0 010-6zM3 3h6v2H3z" fill="#00f0ff"/></svg>
        </button>
      </div>
    </div>

    <div class="search" style="margin-top:8px">
      <svg viewBox="0 0 24 24" style="width:18px;height:18px;opacity:0.9;fill:var(--accent-cyan)"><path d="M21 21l-5.2-5.2M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"/></svg>
      <input id="contactSearch" placeholder="Search contacts" />
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div style="font-weight:700;color:var(--muted)">Contacts</div>
      <div id="contactsCount" style="font-size:13px;color:rgba(190,239,255,0.6)">0</div>
    </div>

    <div class="contacts" id="contactsList"></div>
  </aside>

  <!-- CENTER: CHAT -->
  <main class="chat-area glass">
    <div class="chat-header">
      <div style="display:flex;gap:12px;align-items:center">
        <div id="chatAvatar" class="avatar" style="background:linear-gradient(90deg,var(--accent-cyan),#ff00f0)"><svg viewBox="0 0 24 24" style="width:26px;height:26px;fill:#061018"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c4 0 8 2 8 4v2H4v-2c0-2 4-4 8-4z"/></svg></div>
        <div>
          <div id="chatName" style="font-weight:700">Select a contact</div>
          <div id="chatStatus" style="font-size:12px;color:rgba(190,239,255,0.6)">Offline</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div id="encryptionBadge" class="encryption-badge hidden" title="End-to-end encryption enabled">üîí Encrypted</div>
        <button id="toggleE2E" class="icon-btn" title="Toggle E2E (demo)">üîê</button>
        <button id="callBtn" class="icon-btn" title="Call"><svg viewBox="0 0 24 24"><path d="M6.6 10.8c1.8 3.6 4.8 6.6 8.4 8.4l2.1-2.1c.2-.2.5-.3.8-.2 1 .2 2 .3 3.1.3.6 0 1 .5 1 1V21c0 .6-.4 1-1 1C9.3 22 2 14.7 2 6c0-.6.4-1 1-1h3.3c.6 0 1 .4 1 1 0 1 .1 2.1.3 3.1.1.3 0 .6-.1.8L6.6 10.8z" fill="#00f0ff"/></svg></button>
      </div>
    </div>

    <div class="chat-main" id="chatMain">
      <div class="messages" id="messages"></div>
      <div id="typingIndicator" class="hidden" style="padding-left:8px"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>
    </div>

    <div>
      <div class="quick-chips" id="quickChips" style="margin-top:6px">
        <div class="chip">On my way</div>
        <div class="chip">Be there in 5</div>
        <div class="chip">Running late</div>
      </div>

      <div style="position:relative;margin-top:10px">
        <div id="emojiPanel" class="emoji-panel hidden" aria-hidden="true"><div class="emoji-tabs" id="emojiTabs"></div><div class="emoji-grid" id="emojiGrid"></div></div>

        <div class="composer">
          <button id="emojiBtn" class="icon-btn" title="Emoji"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 7a7 7 0 0114 0H5z" fill="#00f0ff"/></svg></button>

          <textarea id="messageInput" placeholder="Type a message..." rows="1" aria-label="Message input"></textarea>

          <!-- image preview bubble -->
          <div id="imageBubble" class="image-bubble hidden" title="Click to remove">
            <div id="removeBubble" class="remove-bubble">√ó</div>
            <img id="bubbleImg" src="" alt="preview" />
          </div>

          <input id="fileInput" type="file" accept="image/*,audio/*" class="hidden" aria-hidden="true">

          <!-- voice / attach -->
          <button id="recordBtn" class="icon-btn" title="Hold to record (press to start)"><svg viewBox="0 0 24 24"><path d="M12 14a3 3 0 003-3V6a3 3 0 10-6 0v5a3 3 0 003 3zM19 11a1 1 0 10-2 0 5 5 0 01-10 0 1 1 0 10-2 0 7 7 0 006 6.92V21h2v-3.08A7 7 0 0019 11z" fill="#00f0ff"/></svg></button>

          <button id="attachBtn" class="icon-btn" title="Attach file"><svg viewBox="0 0 24 24"><path d="M21.44 11.05L12.53 2.14a4 4 0 00-5.66 5.66l7.07 7.07a2 2 0 002.83 0 2 2 0 000-2.83l-4.24-4.24" stroke="#00f0ff" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></button>

          <button id="sendBtn" class="icon-btn" title="Send"><svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z" fill="#00f0ff"/></svg></button>
        </div>
      </div>
    </div>
  </main>

  <!-- RIGHT: contact details -->
  <aside class="sidebar-right glass" id="sidebarRight">
    <div id="contactCardEmpty" style="text-align:center;padding:14px">
      <div style="width:88px;height:88px;border-radius:999px;background:linear-gradient(90deg,#00f0ff,#a6ff00);display:inline-flex;align-items:center;justify-content:center;margin:auto">
        <svg viewBox="0 0 24 24" style="width:44px;height:44px;fill:#061018"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c4 0 8 2 8 4v2H4v-2c0-2 4-4 8-4z"/></svg>
      </div>
      <div style="font-weight:700;margin-top:8px" id="detailName">No contact selected</div>
      <div class="kv" id="detailStatus">Select a conversation to view details</div>
    </div>

    <div id="contactCard" style="display:none; width:100%">
      <div class="contact-card">
        <div class="big-avatar" id="detailAvatar" style="width:88px;height:88px;border-radius:999px;background:linear-gradient(90deg,#00f0ff,#ff00f0);display:flex;align-items:center;justify-content:center">
          <svg viewBox="0 0 24 24" style="width:44px;height:44px;fill:#061018"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c4 0 8 2 8 4v2H4v-2c0-2 4-4 8-4z"/></svg>
        </div>
        <div style="font-weight:800;font-size:18px" id="detailName2">Name</div>
        <div class="kv" id="detailPresence">Online</div>
        <div style="display:flex;gap:8px;width:100%">
          <button id="saveContactBtn" class="btn-primary">Save to Contacts</button>
          <button id="blockBtn" class="btn-ghost">Block</button>
        </div>
      </div>

      <div class="glass" style="padding:10px">
        <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Shared Media</div>
        <div id="sharedMedia" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>

      <div class="glass" style="padding:10px">
        <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Contact Info</div>
        <div class="detail-row"><div class="kv">Phone</div><div id="detailPhone" class="kv">‚Äî</div></div>
        <div class="detail-row"><div class="kv">Email</div><div id="detailEmail" class="kv">‚Äî</div></div>
      </div>
    </div>
  </aside>
</div>

<!-- FOOTER -->
<div class="page-footer" role="navigation" aria-label="main navigation">
  <a href="student-dashboard.html" title="Home" aria-label="Home">
    <svg viewBox="0 0 24 24"><path d="M12 3l9 8h-3v8h-4v-5h-4v5H6v-8H3z"></path></svg>
  </a>
  <a id="openContactsFooter" title="Contacts" aria-label="Contacts" style="cursor:pointer">
    <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
  </a>
  <a id="openDetailsFooter" title="Details" aria-label="Details" style="cursor:pointer">
    <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
  </a>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" style="display:none;position:fixed;inset:0;z-index:220;align-items:center;justify-content:center;background:rgba(2,4,10,0.7)">
  <div style="width:92%;max-width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(12px)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="font-family:Orbitron;color:var(--accent-cyan);margin:0">Add Contact</h3>
      <button id="closeAddContact" style="background:none;border:none;color:#ff99cc;font-size:18px;cursor:pointer">√ó</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <input id="newName" placeholder="Full name" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
      <input id="newPhone" placeholder="Phone" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
      <input id="newEmail" placeholder="Email (optional)" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveContact" class="btn-primary">Save</button>
        <button id="cancelSave" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   CONFIG - REPLACE THESE
   =======================
   Put your Supabase values here.
*/
const SUPABASE_URL = 'https://YOUR_SUPABASE_URL.supabase.co';         // <<-- REPLACE
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';                   // <<-- REPLACE
const STORAGE_BUCKET = 'chat-media';                                  // ensure bucket exists

/* -----------------------
   Init supabase client
------------------------*/
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } } });

/* =======================
   App State
=======================*/
let user = { id: 'user_demo_1', name: 'You' }; // TODO: replace with real auth
const TABLE = 'chat_messages';   // per your choice
const REACTIONS_TABLE = 'reactions'; // assumed table schema (id, message_id, user_id, emoji, created_at)

let contacts = [];      // loaded from either supabase or local demo
let activeContactId = null;
let messagesCache = {}; // per contact
let convoKeyStore = {}; // local map for symmetric keys per conversation (base64)

/* =======================
   Utilities
=======================*/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function uid(p='id'){ return p + Math.random().toString(36).slice(2,9); }
function timeNow(){ return new Date().toISOString(); }
function formatTimeISO(iso){ return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

/* =======================
   Encryption helpers (AES-GCM)
   - demo-friendly: store per conversation key in localStorage as base64
   - production: proper key exchange needed (Signal protocol)
=======================*/
async function generateSymKeyFor(convId){
  const key = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt','decrypt']);
  const raw = await crypto.subtle.exportKey('raw', key);
  const b64 = arrayBufferToBase64(raw);
  localStorage.setItem(`e2e_key_${convId}`, b64);
  convoKeyStore[convId] = key;
  return key;
}
async function loadSymKey(convId){
  if(convoKeyStore[convId]) return convoKeyStore[convId];
  const b64 = localStorage.getItem(`e2e_key_${convId}`);
  if(!b64) return null;
  const raw = base64ToArrayBuffer(b64);
  const key = await crypto.subtle.importKey('raw', raw, 'AES-GCM', true, ['encrypt','decrypt']);
  convoKeyStore[convId] = key;
  return key;
}
function arrayBufferToBase64(buffer){
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for (let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
function base64ToArrayBuffer(b64){
  const binary = atob(b64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
  return bytes.buffer;
}
async function encryptForConv(convId, plaintext){
  const key = await loadSymKey(convId);
  if(!key) return null;
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(plaintext);
  const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key);
  // We need to include iv + ciphertext
  // Actually do encryption properly: include iv + ciphertext
  // Sorry ‚Äî fix to produce combined buffer:
  const ciphertext = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc);
  const combined = new Uint8Array(iv.byteLength + ciphertext.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(ciphertext), iv.byteLength);
  return arrayBufferToBase64(combined.buffer);
}
async function decryptForConv(convId, b64){
  const key = await loadSymKey(convId);
  if(!key) return null;
  try{
    const combined = base64ToArrayBuffer(b64);
    const combinedView = new Uint8Array(combined);
    const iv = combinedView.slice(0,12);
    const ciphertext = combinedView.slice(12).buffer;
    const plainBuffer = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ciphertext);
    return new TextDecoder().decode(plainBuffer);
  } catch(e){
    console.warn('decrypt failed', e);
    return null;
  }
}

/* =======================
   UI bindings & init
=======================*/
const contactListEl = $('#contactsList');
const contactsCountEl = $('#contactsCount');
const messagesEl = $('#messages');
const chatNameEl = $('#chatName');
const chatStatusEl = $('#chatStatus');
const chatAvatarEl = $('#chatAvatar');
const addContactModal = $('#addContactModal');
const contactSearch = $('#contactSearch');

const messageInput = $('#messageInput');
const sendBtn = $('#sendBtn');
const attachBtn = $('#attachBtn');
const fileInput = $('#fileInput');
const imageBubble = $('#imageBubble');
const bubbleImg = $('#bubbleImg');
const removeBubble = $('#removeBubble');
const recordBtn = $('#recordBtn');
const emojiBtn = $('#emojiBtn');
const emojiPanel = $('#emojiPanel');
const emojiTabs = $('#emojiTabs');
const emojiGrid = $('#emojiGrid');
const toggleE2EBtn = $('#toggleE2E');
const encryptionBadge = $('#encryptionBadge');

let pendingFileData = null;    // data URL or blob URL
let pendingFileType = null;    // 'image' or 'audio'
let mediaRecorder = null;
let audioChunks = [];

/* ----------------------
   Replace with your auth flow in production.
   For demo we create a pseudo contact list & conversation IDs.
------------------------*/
async function seedDemoContacts(){
  // We will load contacts from 'contacts' stored locally (demo)
  const local = localStorage.getItem('zep_contacts_demo');
  if(local){ contacts = JSON.parse(local); return; }
  contacts = [
    { id:'c1', name:'Ama', phone:'+27 71 000 1024', color:'linear-gradient(90deg,#00f0ff,#ff00f0)' },
    { id:'c2', name:'Kofi', phone:'+27 71 000 2048', color:'linear-gradient(90deg,#ff00f0,#a6ff00)' },
    { id:'c3', name:'Lina', phone:'+27 71 000 3096', color:'linear-gradient(90deg,#00f0ff,#a6ff00)' }
  ];
  localStorage.setItem('zep_contacts_demo', JSON.stringify(contacts));
}

/* render contacts */
function renderContacts(filter=''){
  contactListEl.innerHTML = '';
  const filtered = contacts.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()) || (c.phone||'').includes(filter));
  contactsCountEl.innerText = filtered.length;
  filtered.forEach(c=>{
    const last = (messagesCache[c.id] || []);
    const preview = last.length ? (last[last.length-1].text || '[media]') : 'No messages yet';
    const time = last.length ? formatTimeISO(last[last.length-1].created_at) : '';
    const el = document.createElement('div');
    el.className='contact';
    el.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div class="avatar" style="background:${c.color}"><svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:#061018"><path d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c4 0 8 2 8 4v2H4v-2c0-2 4-4 8-4z"/></svg></div>
        <div style="min-width:0">
          <div class="name">${c.name}</div>
          <div class="preview">${preview}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end">
        <div style="font-size:12px;color:rgba(190,239,255,0.6)">${time}</div>
        <div style="display:flex;align-items:center;gap:6px"><div class="dot" style="display:${Math.random()>0.35?'inline-block':'none'}"></div></div>
      </div>
    `;
    el.addEventListener('click', ()=> openConversation(c.id));
    contactListEl.appendChild(el);
  });
}

/* open conversation: load last messages and subscribe */
async function openConversation(contactId){
  activeContactId = contactId;
  const c = contacts.find(x=>x.id===contactId);
  chatNameEl.innerText = c ? c.name : 'Unknown';
  chatStatusEl.innerText = Math.random()>0.3 ? 'Online' : 'Last seen 2h ago';
  chatAvatarEl.style.background = c ? c.color : 'linear-gradient(90deg,#00f0ff,#ff00f0)';
  // load last messages from supabase for this conversation (both directions)
  await loadMessagesFor(contactId);
  renderMessages(contactId);
  // show encryption badge if key exists
  loadSymKey(contactId).then(k => { if(k) encryptionBadge.classList.remove('hidden'); else encryptionBadge.classList.add('hidden'); });
}

/* build query for messages (where sender/receiver match) */
function conversationFilter(contactId){
  // messages where (sender_id=user.id AND receiver_id=contactId) OR (sender_id=contactId AND receiver_id=user.id)
  return supabase
    .from(TABLE)
    .select('*')
    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${contactId}),and(sender_id.eq.${contactId},receiver_id.eq.${user.id})`)
    .order('created_at', { ascending: true });
}

/* load messages for a contact (one-time) */
async function loadMessagesFor(contactId){
  try{
    const { data, error } = await conversationFilter(contactId);
    if(error){ console.error('load messages error', error); return; }
    messagesCache[contactId] = data || [];
    // decrypt if necessary for any encrypted messages (we will try)
    await Promise.all((messagesCache[contactId]||[]).map(async m => {
      if(isProbablyEncrypted(m.message_text)){
        const dec = await decryptForConv(contactId, m.message_text);
        if(dec) {
          try{ m.payload = JSON.parse(dec); m.isEncrypted = true; }
          catch(e){ m.payload = { type:'text', text: dec }; m.isEncrypted = true; }
        } else { m.payload = { type:'text', text:'[Encrypted]' }; m.isEncrypted = true; }
      } else {
        try {
          m.payload = JSON.parse(m.message_text);
        } catch(e) {
          m.payload = { type:'text', text: m.message_text || '' };
        }
      }
    }));
  }catch(e){ console.error(e); }
}

/* helper to determine if string likely base64 combined encrypted (simple heuristic) */
function isProbablyEncrypted(s){
  if(!s) return false;
  // our encrypted messages are base64 and contain characters +/=
  // but plain text can also. We'll check length and not JSON parseable.
  try{ JSON.parse(s); return false; }catch(e){}
  return /^[A-Za-z0-9+/]+=*$/.test(s) && s.length > 80;
}

/* render all messages for contact */
function renderMessages(contactId){
  messagesEl.innerHTML = '';
  const list = messagesCache[contactId] || [];
  list.forEach(m => {
    const row = document.createElement('div'); row.className='msg-row';
    const bubble = document.createElement('div');
    bubble.className = 'msg ' + (m.sender_id === user.id ? 'me' : 'them');
    // payload expected in m.payload
    const p = m.payload || { type:'text', text: m.message_text || '' };
    let html = '';
    if(p.type === 'text') html += `<div>${escapeHtml(p.text)}</div>`;
    else if(p.type === 'image') html += `<div>${p.caption?escapeHtml(p.caption):''}</div><img src="${p.file_url}" alt="img">`;
    else if(p.type === 'voice') html += `<div>Voice message</div><audio controls src="${p.file_url}"></audio>`;
    else html += `<div>${escapeHtml(JSON.stringify(p))}</div>`;
    html += `<div class="meta">${formatTimeISO(m.created_at)} ${m.sender_id===user.id ? (m.status? ' ' + m.status : '') : ''}</div>`;
    // reactions display (if any)
    if(m.reactions && m.reactions.length){
      html += `<div class="reaction-display">` + m.reactions.map(r=>`<div class="reaction-pill">${escapeHtml(r.emoji)} ${r.count||''}</div>`).join('') + `</div>`;
    } else {
      html += `<div class="reaction-display hidden"></div>`;
    }
    bubble.innerHTML = html;
    // right-click or long-press to react
    bubble.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); openReactionPopper(ev, m); });
    bubble.addEventListener('dblclick', ()=> openReactionPopperAtCenter(m));
    row.appendChild(bubble);
    messagesEl.appendChild(row);
  });
  setTimeout(()=> messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight, 80);
}

/* =======================
   Send message flow:
   - prepare payload: {type, text?, file_url?, caption?}
   - if encryption enabled and key exists: encrypt JSON and store base64
   - insert into supabase table: columns per schema: id,sender_id,receiver_id,message_text,created_at
=======================*/
async function sendMessage(){
  if(!activeContactId){ alert('Pick a contact to send to'); return; }
  const text = messageInput.value.trim();
  const hasFile = !!pendingFileData;
  if(!text && !hasFile) return;
  // build payload
  let payload = { type:'text', text };
  if(hasFile){
    payload = { type: pendingFileType === 'audio' ? 'voice' : 'image', file_url: pendingFileData, caption: text || '' };
  }
  // if encryption enabled, encrypt payload JSON
  const e2eKey = await loadSymKey(activeContactId);
  let storedText = '';
  if(e2eKey){
    const json = JSON.stringify(payload);
    const cipher = await encryptForConv(activeContactId, json);
    storedText = cipher;
  } else {
    storedText = JSON.stringify(payload);
  }
  // insert into supabase
  const row = {
    id: uid('m'),
    sender_id: user.id,
    receiver_id: activeContactId,
    message_text: storedText,
    created_at: new Date().toISOString()
  };
  const { error } = await supabase.from(TABLE).insert(row).select();
  if(error){ console.error('insert message', error); alert('Failed to send'); return; }
  // optimistic UI: append locally
  messagesCache[activeContactId] = messagesCache[activeContactId] || [];
  const localMsg = { ...row, payload, status:'sending' };
  messagesCache[activeContactId].push(localMsg);
  renderMessages(activeContactId);
  messageInput.value = '';
  hideImageBubble();
  pendingFileData = null; pendingFileType = null;
}

/* =======================
   File upload (images & voice)
   - upload to Supabase Storage, return publicURL
=======================*/
async function uploadFileToStorage(file, filename){
  try{
    const key = `${Date.now()}_${filename}`;
    const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(key, file, { cacheControl: '3600', upsert:false });
    if(error){ console.error('storage upload', error); return null; }
    // get public url
    const { publicURL, error: e2 } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(data.path);
    if(e2){ console.error(e2); return null; }
    return publicURL;
  }catch(err){ console.error(err); return null; }
}

/* =======================
   File input handling
=======================*/
attachBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  // show preview immediately and upload in background
  const isAudio = f.type.startsWith('audio/');
  const reader = new FileReader();
  reader.onload = async (e) => {
    // show bubble
    pendingFileType = isAudio ? 'audio' : 'image';
    pendingFileData = e.target.result; // dataURL for preview
    showImageBubble(pendingFileData);
    // upload to storage (convert dataURL to blob if necessary)
    let blob = f;
    // call upload
    const publicUrl = await uploadFileToStorage(blob, f.name);
    if(publicUrl){
      // replace pendingFileData with publicUrl for final message
      pendingFileData = publicUrl;
      // update bubble preview (for images)
      if(!isAudio) bubbleImg.src = publicUrl;
    } else {
      alert('Upload failed');
    }
  };
  reader.readAsDataURL(f);
});

/* image bubble */
function showImageBubble(dataUrl){
  bubbleImg.src = dataUrl;
  imageBubble.classList.remove('hidden');
}
function hideImageBubble(){ pendingFileData = null; pendingFileType = null; bubbleImg.src=''; imageBubble.classList.add('hidden'); }
removeBubble.addEventListener('click', hideImageBubble);
imageBubble.addEventListener('click', hideImageBubble);

/* =======================
   Voice recording (MediaRecorder)
   - we record webm and upload to storage, then send message with file_url
=======================*/
recordBtn.addEventListener('click', async ()=>{
  // toggle based on recorder
  if(mediaRecorder && mediaRecorder.state === 'recording'){
    mediaRecorder.stop();
    return;
  }
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert('Recording not supported in this browser');
    return;
  }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      // show small bubble (we use URL for preview)
      const url = URL.createObjectURL(blob);
      pendingFileType = 'audio';
      pendingFileData = url;
      showImageBubble(url);
      // upload to storage
      const publicUrl = await uploadFileToStorage(blob, `voice_${Date.now()}.webm`);
      if(publicUrl){
        pendingFileData = publicUrl;
        // update bubble to use public url? leave preview as object URL (ok)
        alert('Voice recorded and uploaded. Press send to deliver.');
      } else {
        alert('Upload failed');
      }
      stream.getTracks().forEach(t => t.stop());
      mediaRecorder = null;
    };
    mediaRecorder.start();
    // simple UX: change button appearance while recording
    alert('Recording... press the button again to stop.');
  }catch(e){ console.error(e); alert('Could not start recording: ' + e.message); }
});

/* =======================
   Reactions:
   - show a small popper with emojis when user opens reaction picker
   - insert into reactions table: message_id, user_id, emoji
   - subscribe to reactions table to update messages
=======================*/
const REACTION_SET = ['üëç','‚ù§Ô∏è','üòÇ','üî•','üòÆ','üò¢'];
function openReactionPopper(event, message){
  // simple popper near cursor
  const pop = document.createElement('div');
  pop.className = 'reaction-popper';
  REACTION_SET.forEach(emoji=>{
    const b = document.createElement('button');
    b.className = 'icon-btn';
    b.style.fontSize = '18px';
    b.innerText = emoji;
    b.addEventListener('click', async ()=> {
      await addReaction(message.id, emoji);
      document.body.removeChild(pop);
    });
    pop.appendChild(b);
  });
  pop.style.left = (event.pageX - 40) + 'px';
  pop.style.top = (event.pageY - 40) + 'px';
  document.body.appendChild(pop);
  // click outside to close
  const closeFn = (e) => { if(!pop.contains(e.target)) { document.body.removeChild(pop); document.removeEventListener('click', closeFn); } };
  document.addEventListener('click', closeFn);
}
function openReactionPopperAtCenter(message){
  openReactionPopper({ pageX: window.innerWidth/2, pageY: window.innerHeight/2 }, message);
}
async function addReaction(messageId, emoji){
  try{
    const row = { id: uid('r'), message_id: messageId, user_id: user.id, emoji, created_at: new Date().toISOString() };
    const { error } = await supabase.from(REACTIONS_TABLE).insert(row);
    if(error) console.error('reaction insert', error);
  }catch(e){ console.error(e); }
}

/* =======================
   Subscriptions (Realtime)
   - subscribe to INSERTs on chat_messages relevant to this user
   - subscribe to reactions table
=======================*/
function setupRealtime(){
  // messages: listen to new rows (both directions)
  supabase.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: TABLE }, payload => {
      const m = payload.new;
      // determine if relevant to current user: sender or receiver
      if(m.sender_id === user.id || m.receiver_id === user.id){
        // append to cache for that conversation partner
        const other = (m.sender_id === user.id) ? m.receiver_id : m.sender_id;
        messagesCache[other] = messagesCache[other] || [];
        // set created_at
        m.created_at = m.created_at || new Date().toISOString();
        // attempt to parse or decrypt
        (async ()=>{
          if(isProbablyEncrypted(m.message_text)){
            const dec = await decryptForConv(other, m.message_text);
            if(dec) { try{ m.payload = JSON.parse(dec); m.isEncrypted=true; } catch(e){ m.payload={ type:'text', text:dec }; } }
            else m.payload = { type:'text', text:'[Encrypted]' };
          } else {
            try{ m.payload = JSON.parse(m.message_text); } catch(e) { m.payload = { type:'text', text: m.message_text }; }
          }
          // push and render if active conversation
          messagesCache[other].push(m);
          if(other === activeContactId) renderMessages(other);
        })();
      }
    })
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: REACTIONS_TABLE }, payload => {
      // reaction created: update local message reaction state
      const r = payload.new;
      // attach to message in cache
      Object.keys(messagesCache).forEach(convId=>{
        messagesCache[convId].forEach(m=>{
          if(m.id === r.message_id){
            m.reactions = m.reactions || [];
            // naive aggregate: count per emoji
            let entry = m.reactions.find(x=>x.emoji === r.emoji);
            if(entry) entry.count = (entry.count||1) + 1; else m.reactions.push({ emoji: r.emoji, count: 1 });
          }
        });
      });
      if(activeContactId) renderMessages(activeContactId);
    })
    .subscribe();
}

/* =======================
   Emoji picker build (full sheet)
=======================*/
const EMOJI_CATEGORIES = {
  'Smileys': ['üòÄ','üòÅ','üòÇ','ü§£','üòä','üòç','üòò','üòú','ü§î','ü§ó','üòÖ','üòá'],
  'People': ['üëã','üëç','üëè','ü§ù','üôå','üôè','üí™','ü§≥','üßë‚Äçüè´','üßë‚Äçüíª','üßë‚Äçüîß','üßë‚Äçüç≥'],
  'Nature': ['üå±','üåø','‚òòÔ∏è','üå∏','üåº','üåû','üåßÔ∏è','‚ùÑÔ∏è','üî•','üåä','üåà','üåô'],
  'Food': ['üçé','üçî','üçï','üç£','üç©','‚òï','üç∫','üç∑','üç´','üç™','üåÆ','ü•ó'],
  'Activities': ['‚öΩ','üèÄ','üèà','üéÆ','üé∏','üé®','üé¨','üéß','üß©','üé≤','üèä','üö¥'],
  'Travel': ['üöó','üõµ','üöï','üöö','‚úàÔ∏è','üöÄ','üõ≥Ô∏è','üß≠','üó∫Ô∏è','üèùÔ∏è','üè®','üõ£Ô∏è'],
  'Symbols': ['‚ù§Ô∏è','‚ú®','‚≠ê','‚úîÔ∏è','‚ùó','‚ùì','‚ö†Ô∏è','üîî','üîí','üí°','üíØ','üîÅ']
};
function buildEmojiPicker(){
  emojiTabs.innerHTML=''; emojiGrid.innerHTML='';
  Object.keys(EMOJI_CATEGORIES).forEach((cat, idx)=>{
    const t = document.createElement('button'); t.className='emoji-tab' + (idx===0?' active':''); t.innerText = cat; t.dataset.cat = cat;
    t.addEventListener('click', ()=> { document.querySelectorAll('.emoji-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); loadEmojiGrid(cat); });
    emojiTabs.appendChild(t);
  });
  loadEmojiGrid(Object.keys(EMOJI_CATEGORIES)[0]);
}
function loadEmojiGrid(cat){ emojiGrid.innerHTML=''; EMOJI_CATEGORIES[cat].forEach(e=>{ const c=document.createElement('div'); c.className='emoji-cell'; c.innerText=e; c.addEventListener('click', ()=> { insertEmoji(e); closeEmojiPanel(); }); emojiGrid.appendChild(c); }); }
function insertEmoji(e){ const el = messageInput; const start = el.selectionStart||0; const end = el.selectionEnd||0; const text = el.value||''; el.value = text.slice(0,start) + e + text.slice(end); el.focus(); el.selectionStart = el.selectionEnd = start + e.length; }
function openEmojiPanel(){ emojiPanel.classList.remove('hidden'); emojiPanel.setAttribute('aria-hidden','false'); }
function closeEmojiPanel(){ emojiPanel.classList.add('hidden'); emojiPanel.setAttribute('aria-hidden','true'); }
emojiBtn.addEventListener('click', ()=> { if(emojiPanel.classList.contains('hidden')) openEmojiPanel(); else closeEmojiPanel(); });
document.addEventListener('click', (e)=> { if(!emojiPanel.classList.contains('hidden')){ if(!emojiPanel.contains(e.target) && e.target !== emojiBtn) closeEmojiPanel(); } });

/* =======================
   E2E toggle: generate key for conversation or remove
=======================*/
toggleE2EBtn.addEventListener('click', async ()=>{
  if(!activeContactId){ alert('Open a conversation first'); return; }
  const key = await loadSymKey(activeContactId);
  if(key){
    if(confirm('Disable local E2E for this conversation? This will remove the local key (messages remain encrypted on server).')){
      localStorage.removeItem(`e2e_key_${activeContactId}`);
      delete convoKeyStore[activeContactId];
      encryptionBadge.classList.add('hidden');
      alert('E2E disabled for this conversation (local key removed).');
    }
  } else {
    // generate
    await generateSymKeyFor(activeContactId);
    encryptionBadge.classList.remove('hidden');
    alert('E2E enabled for this conversation (local key stored). Share the key with the other party out-of-band in real app.');
  }
});

/* =======================
   Realtime init & start
=======================*/
buildEmojiPicker();
seedDemoContacts().then(()=> renderContacts(''));
setupRealtime();

/* open first conversation for demo */
if(contacts.length) openConversation(contacts[0].id);

/* Send button wiring */
$('#sendBtn').addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } else { /*typing indicator*/ } });

/* Add contact modal */
$('#openAddContact').addEventListener('click', ()=> addContactModal.style.display = 'flex');
$('#closeAddContact').addEventListener('click', ()=> addContactModal.style.display = 'none');
$('#cancelSave').addEventListener('click', ()=> addContactModal.style.display = 'none');
$('#saveContact').addEventListener('click', ()=>{
  const name = $('#newName').value.trim(); const phone = $('#newPhone').value.trim(); const email = $('#newEmail').value.trim();
  if(!name||!phone){ alert('name & phone required'); return; }
  const newC = { id: uid('c'), name, phone, email, color: `linear-gradient(90deg,${randomColor()},${randomColor()})` };
  contacts.unshift(newC); localStorage.setItem('zep_contacts_demo', JSON.stringify(contacts)); renderContacts('');
  addContactModal.style.display='none';
  $('#newName').value=''; $('#newPhone').value=''; $('#newEmail').value='';
});

/* search */
contactSearch.addEventListener('input', (e)=> renderContacts(e.target.value));

/* open/close side panels on mobile (footer) */
$('#openContactsFooter').addEventListener('click', ()=> { $('#sidebarLeft').classList.toggle('open'); $('#sidebarRight').classList.remove('open'); });
$('#openDetailsFooter').addEventListener('click', ()=> { $('#sidebarRight').classList.toggle('open'); $('#sidebarLeft').classList.remove('open'); });

/* helper */
function randomColor(){ const pool=['#00f0ff','#ff00f0','#a6ff00','#8ef8b8','#ffd166']; return pool[Math.floor(Math.random()*pool.length)]; }
function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* =======================
   Reactions table note:
   - Ensure your Supabase project has a 'reactions' table:
   - id (text PK), message_id (text FK), user_id (text), emoji (text), created_at (timestamptz)
   - Or adjust REACTIONS_TABLE variable accordingly.
=======================*/

</script>
</body>
</html>