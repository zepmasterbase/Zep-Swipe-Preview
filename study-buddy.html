<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zep Study Buddy — Ask Zep AI</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --neon-blue:#00f0ff;
    --neon-pink:#ff00f0;
    --bg:#07020a;
    --glass: rgba(255,255,255,0.04);
  }
  body{background: radial-gradient(circle at 10% 10%, #0a0224, #02000a 60%, #000 100%); color:#e9f1ff; font-family: 'Poppins',sans-serif; margin:0; -webkit-font-smoothing:antialiased;}
  .header{position:sticky;top:0;background: rgba(255,255,255,0.03);backdrop-filter: blur(8px);border-bottom:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:space-between;padding:14px 16px;z-index:30}
  .brand{font-family:'Orbitron',sans-serif;font-weight:700;background:linear-gradient(90deg,var(--neon-blue),var(--neon-pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.05rem}
  .container{max-width:720px;margin:18px auto;padding:0 14px}
  .card{background:var(--glass);border-radius:14px;padding:14px;box-shadow:0 6px 30px rgba(0,240,255,0.04);border:1px solid rgba(255,255,255,0.04)}
  /* Chat area */
  .chat-wrap{height:66vh;min-height:360px;max-height:78vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .bubble{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.25}
  .user{align-self:flex-end;background:linear-gradient(90deg,#00111a 0%, #002533 100%);border:1px solid rgba(0,255,255,0.08);box-shadow:0 4px 20px rgba(0,0,0,0.5)}
  .ai{align-self:flex-start;background:linear-gradient(90deg,rgba(0,240,255,0.06),rgba(255,0,240,0.04));border:1px solid rgba(0,255,255,0.12);box-shadow: 0 6px 24px rgba(0,240,255,0.06)}
  .meta{font-size:0.72rem;opacity:0.8;margin-bottom:6px}
  .input-row{display:flex;gap:8px;margin-top:10px}
  .input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.16);color:#fff;outline:none}
  .send-btn{padding:0 14px;border-radius:12px;background:linear-gradient(90deg,var(--neon-blue),var(--neon-pink));color:#02020a;font-weight:600;display:inline-flex;align-items:center;gap:8px;border:none}
  .small{font-size:0.85rem;color:#bfefff}
  .placeholder{color:#9bdcff}
  .loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--neon-blue);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* Quiz card */
  .quiz-card{background:linear-gradient(90deg, rgba(0,240,255,0.03), rgba(255,0,240,0.02));border-radius:12px;padding:10px;border:1px solid rgba(0,255,255,0.08)}
  .opt{padding:8px;border-radius:8px;margin-top:6px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .opt.correct{background:rgba(0,255,170,0.12);border-color:rgba(0,255,170,0.18)}
  .opt.wrong{background:rgba(255,50,120,0.06);border-color:rgba(255,50,120,0.14)}
  /* responsive */
  @media(max-width:480px){
    .chat-wrap{height:58vh}
    .brand{font-size:0.95rem}
  }
</style>
</head>
<body>
  <header class="header">
    <div class="brand">Zep Study Buddy</div>
    <div class="small placeholder">Ask Zep AI — quick explainers & mini quizzes</div>
  </header>

  <div class="container">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div class="small placeholder">Logged in as</div>
          <div style="font-weight:600">Student • Ama</div>
        </div>
        <div class="small placeholder">Model: Assist-A</div>
      </div>

      <!-- Chat area -->
      <div id="chat" class="chat-wrap" aria-live="polite"></div>

      <!-- Input -->
      <div style="margin-top:12px">
        <div class="input-row">
          <input id="question" class="input" placeholder="Type a question (e.g. 'What is slippage in trading?')" />
          <button id="send" class="send-btn" title="Ask Zep AI">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#02020a"/></svg>
            <span>Ask</span>
          </button>
        </div>
        <div style="margin-top:8px" class="small placeholder">Tip: Ask for examples or quick quizzes. Zep will reply with an explanation, example and 2-question quiz.</div>
      </div>
    </div>
  </div>

<script>
  // Helper: create a bubble
  function pushBubble(text, who='ai', meta='') {
    const chat = document.getElementById('chat');
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble ' + (who==='user' ? 'user' : 'ai');
    if(meta) {
      const m = document.createElement('div'); m.className='meta'; m.textContent = meta; wrapper.appendChild(m);
    }
    if(typeof text === 'string'){
      const p = document.createElement('div'); p.innerHTML = text; wrapper.appendChild(p);
    } else {
      wrapper.appendChild(text); // already an element (e.g. quiz card)
    }
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
  }

  // Show temporary loader bubble
  function showLoader() {
    const loader = document.createElement('div');
    loader.className = 'bubble ai';
    loader.id = '__loader';
    const bar = document.createElement('div'); bar.className='loader';
    loader.appendChild(bar);
    document.getElementById('chat').appendChild(loader);
    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  }
  function removeLoader(){ const l=document.getElementById('__loader'); if(l) l.remove(); }

  // Build quiz element (2 questions)
  function buildQuiz(quizArr) {
    const container = document.createElement('div');
    container.className = 'quiz-card';
    quizArr.forEach((q, idx)=>{
      const qEl = document.createElement('div');
      qEl.style.marginBottom='10px';
      const qTitle = document.createElement('div'); qTitle.style.fontWeight='700'; qTitle.textContent = `Q${idx+1}: ${q.q}`;
      qEl.appendChild(qTitle);
      q.options.forEach(opt => {
        const optEl = document.createElement('div');
        optEl.className = 'opt';
        optEl.textContent = opt;
        optEl.onclick = () => {
          // reveal correct/incorrect
          Array.from(qEl.querySelectorAll('.opt')).forEach(o=>o.classList.remove('correct','wrong'));
          const selectedText = opt;
          if(selectedText.startsWith(q.answer)) {
            optEl.classList.add('correct');
          } else {
            optEl.classList.add('wrong');
            // mark correct
            Array.from(qEl.querySelectorAll('.opt')).forEach(o=>{
              if(o.textContent.startsWith(q.answer)) o.classList.add('correct');
            });
          }
          // disable clicks
          Array.from(qEl.querySelectorAll('.opt')).forEach(o=>o.onclick=null);
        };
        qEl.appendChild(optEl);
      });
      container.appendChild(qEl);
    });
    // small hint
    const hint = document.createElement('div'); hint.className='small placeholder'; hint.style.marginTop='6px'; hint.textContent = 'Select an option to check answer.'; container.appendChild(hint);
    return container;
  }

  // Handle sending question to server
  async function askZep(questionText) {
    if(!questionText || !questionText.trim()) return;
    // push user bubble
    pushBubble(questionText, 'user', 'You');
    document.getElementById('question').value = '';
    showLoader();

    try {
      const res = await fetch('/api/studybuddy', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ question: questionText })
      });
      removeLoader();
      if(!res.ok) {
        const txt = await res.text();
        pushBubble('Sorry — server error: ' + txt, 'ai', 'Zep');
        return;
      }
      const json = await res.json();
      // expected: { explanation, example, quiz: [{q, options:[...], answer:'A'}...] }
      // Explanation bubble
      pushBubble(`<strong>Explanation:</strong><br>${escapeHtml(json.explanation)}`, 'ai', 'Zep');
      // Example bubble
      pushBubble(`<strong>Real-world example:</strong><br>${escapeHtml(json.example)}`, 'ai');
      // Quiz interactive bubble
      if(Array.isArray(json.quiz) && json.quiz.length > 0) {
        const quizEl = buildQuiz(json.quiz);
        pushBubble(quizEl, 'ai');
      }
    } catch (err) {
      removeLoader();
      pushBubble('Network error: ' + err.message, 'ai', 'Zep');
    }
  }

  // simple html escape
  function escapeHtml(s){ return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') : ''; }

  // UI bindings
  document.getElementById('send').addEventListener('click', ()=> {
    const q = document.getElementById('question').value;
    askZep(q);
  });
  document.getElementById('question').addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); askZep(document.getElementById('question').value);
    }
  });

  // initial welcome
  pushBubble(`<strong>Welcome to Zep Study Buddy!</strong><br>Ask any Web3 / trading / study question and get a short explainer, example and a 2-question quiz.`, 'ai', 'Zep');
</script>
</body>
</html>