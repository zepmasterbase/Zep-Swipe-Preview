<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zep Swipe â€” Student Wallet</title>

  <!-- Fonts + Ethers -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>

  <style>
    :root{
      --zep-blue:#00f0ff;
      --zep-violet:#9c4dff;
      --bg: radial-gradient(circle at 20% 10%, #020014 0%, #000007 100%);
      --glass: rgba(255,255,255,0.05);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{
      max-width:980px;
      margin:28px auto;
      padding:18px;
    }

    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px;
      border-radius:14px;
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(12px);
      box-shadow:0 10px 40px rgba(0,240,255,0.04);
      animation:headerPulse 3.5s infinite alternate;
    }
    @keyframes headerPulse{
      from{box-shadow:0 6px 20px rgba(0,240,255,0.06)}
      to{box-shadow:0 12px 36px rgba(156,77,255,0.08)}
    }
    .brand{
      font-family:'Orbitron';
      font-size:20px;
      background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 0 14px rgba(0,240,255,0.15);
    }
    .walletAddr{
      text-align:right;
      font-family:'Orbitron';
      color:#bffcff;
      font-size:0.95rem;
    }
    .logoutBtn{
      margin-left:10px;
      background:transparent;border:0;cursor:pointer;padding:6px;border-radius:8px;
      filter:drop-shadow(0 0 8px rgba(255,80,80,0.85));
    }

    /* Portfolio card */
    .grid{
      display:grid;
      grid-template-columns:1fr 360px;
      gap:18px;
      margin-top:18px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:16px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 12px 40px rgba(0,240,255,0.02);
      backdrop-filter:blur(10px);
    }

    .portfolio{
      border-radius:16px;
      padding:18px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 14px 50px rgba(0,240,255,0.04);
      animation:pulseGlass 4s infinite alternate;
    }
    @keyframes pulseGlass{
      from{box-shadow:0 10px 30px rgba(0,240,255,0.08)}
      to{box-shadow:0 18px 60px rgba(156,77,255,0.10)}
    }

    .coinRow{display:flex;align-items:center;gap:14px}
    .coinBadge{
      width:72px;height:72px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--zep-blue),var(--zep-violet));
      color:#050015;font-family:Orbitron;font-weight:700;font-size:18px;
      box-shadow:0 12px 40px rgba(0,240,255,0.12);
    }
    .meta {flex:1}
    .meta .big{font-family:Orbitron;font-size:20px;margin:0}
    .meta .small{opacity:0.85;font-size:13px;margin-top:6px;color:#d8f8ff}

    .miniGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .mini{padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(0,240,255,0.02), rgba(156,77,255,0.02));text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .mini.disabled{opacity:0.45;cursor:not-allowed;filter:none;box-shadow:none}

    .btn-primary{
      display:inline-block;
      margin-top:12px;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));
      color:#050015;font-weight:700;font-family:Orbitron;
      border:none;cursor:pointer;
      box-shadow:0 12px 30px rgba(0,240,255,0.12);
    }

    /* Right column quick actions */
    .rightBox{display:flex;flex-direction:column;gap:12px}
    .actionCard{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04)}
    .smallMuted{font-size:13px;opacity:0.8;color:#bfefff}

    /* Footer */
    .footer{
      position:fixed;left:0;right:0;bottom:0;padding:12px 20px;
      background:rgba(0,0,0,0.55);backdrop-filter:blur(8px);
      display:flex;justify-content:space-around;gap:12px;
      border-top:1px solid rgba(255,255,255,0.03);
    }
    .fbtn{
      width:68px;height:68px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);
      filter:drop-shadow(0 8px 20px rgba(0,240,255,0.04));transition:transform .18s;
    }
    .fbtn:hover{transform:translateY(-6px);filter:drop-shadow(0 14px 40px rgba(156,77,255,0.12));}

    /* AI bubble */
    .aiBubble{
      position:fixed;right:18px;bottom:110px;background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));
      color:#050015;padding:12px 16px;border-radius:999px;font-family:Orbitron;font-weight:700;cursor:pointer;box-shadow:0 12px 35px rgba(156,77,255,0.14);
    }

    /* Modal simple */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{width:420px;max-width:92%;background:var(--glass);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(12px)}
    .field{margin-top:10px}
    input[type="text"], input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff}

    .muted{opacity:0.8;color:#cfeffd;font-size:13px}

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">Zep Swipe</div>
      <div>
        <div id="loggedAddr" class="walletAddr">â€”</div>
        <div style="text-align:right;margin-top:8px">
          <button class="logoutBtn" id="logoutBtn" title="Logout">
            <!-- logout -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- left: portfolio & actions -->
      <div>
        <div class="card portfolio">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="smallMuted">Portfolio</div>
              <div style="font-family:Orbitron;font-size:18px;margin-top:6px">Your holdings</div>
            </div>
            <div class="smallMuted">Base Mainnet</div>
          </div>

          <div style="display:flex;align-items:center;margin-top:12px">
            <div class="coinBadge">ZAC</div>
            <div class="meta">
              <div class="big" id="zacAmount">25 ZAC</div>
              <div class="small" id="zacUsd">â‰ˆ $3.75 USD</div>
            </div>
          </div>

          <hr style="opacity:0.08;margin:14px 0">

          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="smallMuted">USDT balance</div>
            <div id="usdtBal" style="font-family:Orbitron">â€”</div>
          </div>

          <div class="miniGrid">
            <div class="mini" id="sendBtn">Send</div>
            <div class="mini" id="receiveBtn">Receive</div>
            <!-- Disabled features -->
            <div class="mini disabled">ZepShop (soon)</div>
            <div class="mini disabled">ParcelOn (soon)</div>
          </div>

        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="margin:0;font-family:Orbitron">Activity</h4>
          <div class="muted" style="margin-top:8px">Recent transactions & rewards (demo)</div>
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <div><strong>Earned</strong><div class="muted">Zep quiz â€” +25 ZAC</div></div>
              <div style="font-family:Orbitron">+25 ZAC</div>
            </div>
            <div style="display:flex;justify-content:space-between">
              <div><strong>Sale</strong><div class="muted">Guide sold â€” +8 ZAC</div></div>
              <div style="font-family:Orbitron">+8 ZAC</div>
            </div>
          </div>
        </div>
      </div>

      <!-- right column -->
      <div class="rightBox">
        <div class="actionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="smallMuted">Quick</div>
              <div style="font-family:Orbitron">Add funds / Swap</div>
            </div>
            <button class="btn-primary" id="addFunds">Add Funds</button>
          </div>
          <div class="muted" style="margin-top:10px">Swap support (coming soon)</div>
        </div>

        <div class="actionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="smallMuted">Zep Study</div>
              <div style="font-family:Orbitron">Learn & earn</div>
            </div>
            <button class="btn-primary" id="learnBtn">Open</button>
          </div>
        </div>

        <div class="actionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="smallMuted">Withdraw</div>
              <div style="font-family:Orbitron">To bank (placeholder)</div>
            </div>
            <button class="btn-primary disabled" disabled>Withdraw</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- footer -->
  <div class="footer">
    <a class="fbtn" href="student-dashboard.html" title="Home">
      <!-- home replaced with store icon per earlier ask -->
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="7" width="18" height="13" rx="2" stroke="url(#s1)" stroke-width="1.3"/>
        <path d="M3 11h18" stroke="url(#s1)" stroke-width="1.3"/>
        <defs><linearGradient id="s1" x1="0" x2="1"><stop stop-color="#00f0ff"/><stop offset="1" stop-color="#9c4dff"/></linearGradient></defs>
      </svg>
    </a>

    <a class="fbtn" href="activities.html" title="Activities">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
        <path d="M3 12h18" stroke="url(#a1)" stroke-width="1.6"/>
        <path d="M3 6h18" stroke="url(#a1)" stroke-width="1.2"/>
        <defs><linearGradient id="a1" x1="0" x2="1"><stop stop-color="#00f0ff"/><stop offset="1" stop-color="#9c4dff"/></linearGradient></defs>
      </svg>
    </a>

    <a class="fbtn" href="student-wallet.html" title="Wallet">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
        <rect x="2" y="6" width="20" height="12" rx="2" stroke="url(#w1)" stroke-width="1.4"/>
        <defs><linearGradient id="w1" x1="0" x2="1"><stop stop-color="#00f0ff"/><stop offset="1" stop-color="#9c4dff"/></linearGradient></defs>
      </svg>
    </a>

    <a class="fbtn" href="profile.html" title="Profile">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="8" r="3" stroke="url(#p1)" stroke-width="1.4"/>
        <path d="M4 20c1.5-4 7-6 8-6s6.5 2 8 6" stroke="url(#p1)" stroke-width="1.4"/>
        <defs><linearGradient id="p1" x1="0" x2="1"><stop stop-color="#00f0ff"/><stop offset="1" stop-color="#9c4dff"/></linearGradient></defs>
      </svg>
    </a>
  </div>

  <!-- AI bubble -->
  <button class="aiBubble" id="openAI">ðŸ’¬ Zep AI</button>

  <!-- Send / Receive modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal" id="modal">
      <div id="modalTitle" style="font-family:Orbitron;font-weight:700">Send</div>
      <div class="muted" id="modalSub">Send USDT to another address</div>

      <div class="field">
        <label class="muted">Recipient address</label>
        <input type="text" id="toAddr" placeholder="0x..." />
      </div>

      <div class="field">
        <label class="muted">Amount (USDT)</label>
        <input type="number" id="amount" placeholder="0.00" min="0" step="0.000001" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="confirmSend" class="btn-primary">Confirm & Send</button>
        <button id="closeModal" class="btn-primary" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)">Cancel</button>
      </div>

      <div id="txStatus" style="margin-top:10px;font-size:13px;color:#cfeffd"></div>
    </div>
  </div>

<script>
/* -------------------------
   CONFIG / TOKEN ADDRESS
   - Replace USDT_TOKEN_ADDRESS with the Base mainnet USDT contract if different.
------------------------- */
// Example placeholder; replace with official Base-USDT if you have one:
const USDT_TOKEN_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // <-- CHANGE if needed
const ZAC_TOKEN_ADDRESS = "0xfe4119a9cac1425d808526905e92386b4234bf2a"; // ZAC (simulated)
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function transfer(address to, uint256 amount) returns (bool)"
];
const BASE_RPC = "https://mainnet.base.org";

/* -------------------------
   UI Elements
------------------------- */
const loggedAddrEl = document.getElementById('loggedAddr');
const zacAmountEl = document.getElementById('zacAmount');
const zacUsdEl = document.getElementById('zacUsd');
const usdtBalEl = document.getElementById('usdtBal');

const modalBack = document.getElementById('modalBack');
const modalTitle = document.getElementById('modalTitle');
const modalSub = document.getElementById('modalSub');
const toAddrInput = document.getElementById('toAddr');
const amountInput = document.getElementById('amount');
const confirmSendBtn = document.getElementById('confirmSend');
const closeModalBtn = document.getElementById('closeModal');
const txStatus = document.getElementById('txStatus');

const sendBtn = document.getElementById('sendBtn');
const receiveBtn = document.getElementById('receiveBtn');

const aiBtn = document.getElementById('openAI');

/* -------------------------
   Auth check & setup
------------------------- */
function shortAddr(a){ return a ? `${a.slice(0,6)}...${a.slice(-4)}` : 'â€”'; }
function money(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

function redirectToLogin(){ location.href = 'student-login.html'; }

window.addEventListener('load', async ()=>{
  const session = JSON.parse(localStorage.getItem('zepStudent'));
  if(!session || !session.wallet || !session.loggedIn){
    redirectToLogin();
    return;
  }

  loggedAddrEl.textContent = shortAddr(session.wallet);

  // show simulated ZAC for now
  const simulatedZacAmount = session.zacAmount ?? 25;
  zacAmountEl.textContent = `${simulatedZacAmount} ZAC`;
  const zacPrice = 0.15; // simulated USD price per ZAC
  zacUsdEl.textContent = `â‰ˆ $${money(simulatedZacAmount * zacPrice)} USD`;

  // Start fetching real USDT balance
  await refreshUSDT(session.wallet);
  // refresh periodically
  setInterval(()=> refreshUSDT(session.wallet), 20000);

  // wallet listeners
  setupWalletListeners();
});

/* -------------------------
   Wallet provider listeners (injected wallets)
------------------------- */
function setupWalletListeners(){
  if(window.ethereum && window.ethereum.on){
    window.ethereum.on('accountsChanged', (accounts)=>{
      if(!accounts || accounts.length === 0){
        localStorage.removeItem('zepStudent');
        redirectToLogin();
      } else {
        const w = accounts[0];
        const cur = JSON.parse(localStorage.getItem('zepStudent')) || {};
        cur.wallet = w; cur.loggedIn = true;
        localStorage.setItem('zepStudent', JSON.stringify(cur));
        loggedAddrEl.textContent = shortAddr(w);
        refreshUSDT(w);
      }
    });
    window.ethereum.on('chainChanged', (cId)=>{
      console.log('chainChanged', cId);
      const cur = JSON.parse(localStorage.getItem('zepStudent')) || {};
      if(cur && cur.wallet) refreshUSDT(cur.wallet);
    });
  }
}

/* -------------------------
   Fetch ERC20 balance (USDT)
------------------------- */
async function refreshUSDT(wallet){
  try{
    const provider = new ethers.JsonRpcProvider(BASE_RPC);
    const token = new ethers.Contract(USDT_TOKEN_ADDRESS, ERC20_ABI, provider);
    const [decimals, raw] = await Promise.all([ token.decimals(), token.balanceOf(wallet) ]);
    const formatted = Number(ethers.formatUnits(raw, decimals));
    usdtBalEl.textContent = `${money(formatted)} USDT`;
  }catch(err){
    console.warn('USDT fetch fail', err);
    usdtBalEl.textContent = 'â€”';
  }
}

/* -------------------------
   Send USDT flow (uses injected wallet/signers)
------------------------- */
async function openSendModal(){
  modalTitle.textContent = "Send USDT";
  modalSub.textContent = "Send USDT from your wallet";
  toAddrInput.value = "";
  amountInput.value = "";
  txStatus.textContent = "";
  modalBack.style.display = "flex";
}

async function openReceiveModal(){
  // show address & simple copy button
  modalTitle.textContent = "Receive";
  modalSub.textContent = "Share this address or scan QR";
  const session = JSON.parse(localStorage.getItem('zepStudent'));
  modalBack.style.display = "flex";
  toAddrInput.value = session.wallet || "";
  amountInput.value = "";
  txStatus.textContent = "";
  // make toAddr read-only in receive mode
  toAddrInput.disabled = true;
  confirmSendBtn.style.display = 'none';
}

function closeModal(){
  modalBack.style.display = 'none';
  toAddrInput.disabled = false;
  confirmSendBtn.style.display = 'inline-block';
}

/* build signer and transfer */
async function confirmSend(){
  txStatus.textContent = "Preparing transaction...";
  const to = toAddrInput.value.trim();
  const amt = Number(amountInput.value);
  if(!ethers.isAddress(to)) { txStatus.textContent = "Invalid recipient address."; return; }
  if(!amt || amt <= 0) { txStatus.textContent = "Enter a valid amount."; return; }

  if(!window.ethereum) { txStatus.textContent = "No injected wallet found."; return; }

  try{
    // Connect to injected wallet (user will approve)
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    const decimals = await (new ethers.Contract(USDT_TOKEN_ADDRESS, ERC20_ABI, provider)).decimals();

    // convert to smallest unit
    const amountUnits = ethers.parseUnits(String(amt), decimals);

    // create contract connected to signer
    const tokenWithSigner = new ethers.Contract(USDT_TOKEN_ADDRESS, ERC20_ABI, signer);

    txStatus.textContent = "Requesting wallet approval...";
    const tx = await tokenWithSigner.transfer(to, amountUnits);

    txStatus.textContent = `Sent. Awaiting confirmation (tx: ${tx.hash.slice(0,8)}...)`;
    await tx.wait();

    txStatus.textContent = `Success âœ… (tx: ${tx.hash.slice(0,12)})`;
    // refresh balances
    const s = JSON.parse(localStorage.getItem('zepStudent')) || {};
    if(s.wallet) setTimeout(()=> refreshUSDT(s.wallet), 1500);
  }catch(err){
    console.error(err);
    txStatus.textContent = err?.message?.slice(0,240) || "Transaction failed or rejected";
  }
}

/* -------------------------
   UI wiring
------------------------- */
sendBtn.addEventListener('click', openSendModal);
receiveBtn.addEventListener('click', openReceiveModal);
closeModalBtn.addEventListener('click', closeModal);
confirmSendBtn.addEventListener('click', confirmSend);

document.getElementById('addFunds').addEventListener('click', ()=>{
  alert('Add funds flow coming soon.');
});
document.getElementById('learnBtn').addEventListener('click', ()=>{
  window.location.href = 'learn-earn.html';
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('zepStudent');
  location.href = 'student-login.html';
});

aiBtn.addEventListener('click', ()=>{
  window.open('zep-ai.html','zepai','width=420,height=640');
});
</script>
</body>
</html>